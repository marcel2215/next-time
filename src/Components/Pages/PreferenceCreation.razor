@page "/d/{declarationId}/add-suggestion"
@inject NavigationManager NavigationManager
@inject DeclarationManager DeclarationManager
@inject PreferenceManager PreferenceManager

<PageTitle>NextTime - Edit My Preferences</PageTitle>

@if (_declaration == null)
{
    <LoadingScreen />
    return;
}

<div class="space-y-4">
    <h1 class="text-4xl font-bold">When can you come to this event?</h1>
    <p>Choose all days that fit you. NextTime will find the best date for all participants.</p>
    <div class="space-y-2">
        @foreach (var selectableDay in _selectableDays)
        {
            <NTCheckBox @bind-IsChecked="selectableDay.IsSelected">@selectableDay.FriendlyDate</NTCheckBox>
            @if (selectableDay.IsSelected)
            {
                <div class="flex space-x-1 text-xs sm:text-base">
                    <NTCheckBox IsCompact="true" @bind-IsChecked="@selectableDay.Is8AMSelected">8:00</NTCheckBox>
                    <NTCheckBox IsCompact="true" @bind-IsChecked="@selectableDay.Is10AMSelected">10:00</NTCheckBox>
                    <NTCheckBox IsCompact="true" @bind-IsChecked="@selectableDay.Is12PMSelected">12:00</NTCheckBox>
                    <NTCheckBox IsCompact="true" @bind-IsChecked="@selectableDay.Is4PMSelected">16:00</NTCheckBox>
                    <NTCheckBox IsCompact="true" @bind-IsChecked="@selectableDay.Is6PMSelected">18:00</NTCheckBox>
                    <NTCheckBox IsCompact="true" @bind-IsChecked="@selectableDay.Is8PMSelected">20:00</NTCheckBox>
                </div>
                <div class="w-full h-1 bg-gray-100 rounded-xl" />
            }
        }
    </div>
    <NTButton Clicked="LoadMoreDaysAsync">Load more days</NTButton>
    <NTButton Style="ButtonStyle.Accent" Clicked="SaveSuggestionAsync">Save Suggestion</NTButton>
</div>

@code {
    private Declaration? _declaration;

    private List<SelectableDay> _selectableDays = [];

    [Parameter]
    public string? DeclarationId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (Guid.TryParse(DeclarationId, out var declarationGuid))
        {
            _declaration = await DeclarationManager.FindByIdAsync(declarationGuid);
        }

        if (_declaration == null)
        {
            NavigationManager.NavigateTo("/");
        }

        await LoadMoreDaysAsync();
    }

    private async Task LoadMoreDaysAsync()
    {
        var lastTime = _selectableDays.LastOrDefault()?.Time ?? DateTimeOffset.UtcNow.Date;
        for (var i = 1; i <= 14; i++)
        {
            var futureTime = lastTime.AddDays(i);
            _selectableDays.Add(new SelectableDay(futureTime));
        }

        await LoadSuggestionsAsync();
    }

    private async Task LoadSuggestionsAsync()
    {
        if (_declaration == null)
        {
            return;
        }

        await foreach (var preference in DeclarationManager.GetPreferences(_declaration).AsNoTracking().AsAsyncEnumerable())
        {
            var selectableDay = _selectableDays.FirstOrDefault(d => d.Time.Date == preference.SuggestedTime.Date);
            if (selectableDay != null)
            {
                var isAnySelected = false;

                if (preference.SuggestedTime.Hour == 8)
                {
                    selectableDay.Is8AMSelected = true;
                    isAnySelected = true;
                }

                if (preference.SuggestedTime.Hour == 10)
                {
                    selectableDay.Is10AMSelected = true;
                    isAnySelected = true;
                }

                if (preference.SuggestedTime.Hour == 12)
                {
                    selectableDay.Is12PMSelected = true;
                    isAnySelected = true;
                }

                if (preference.SuggestedTime.Hour == 16)
                {
                    selectableDay.Is4PMSelected = true;
                    isAnySelected = true;
                }

                if (preference.SuggestedTime.Hour == 18)
                {
                    selectableDay.Is6PMSelected = true;
                    isAnySelected = true;
                }

                if (preference.SuggestedTime.Hour == 20)
                {
                    selectableDay.Is8PMSelected = true;
                    isAnySelected = true;
                }

                if (isAnySelected)
                {
                    selectableDay.IsSelected = true;
                }
            }

            StateHasChanged();
        }
    }

    private async Task SaveSuggestionAsync()
    {
        if (_declaration == null)
        {
            return;
        }

        var preferences = new List<Preference>();
        foreach (var selectableDay in _selectableDays.Where(d => d.IsSelected))
        {
            if (selectableDay.Is8AMSelected)
            {
                var preference = new Preference(_declaration.Id, selectableDay.Time.AddHours(8));
                preferences.Add(preference);
            }

            if (selectableDay.Is10AMSelected)
            {
                var preference = new Preference(_declaration.Id, selectableDay.Time.AddHours(10));
                preferences.Add(preference);
            }

            if (selectableDay.Is12PMSelected)
            {
                var preference = new Preference(_declaration.Id, selectableDay.Time.AddHours(12));
                preferences.Add(preference);
            }

            if (selectableDay.Is4PMSelected)
            {
                var preference = new Preference(_declaration.Id, selectableDay.Time.AddHours(16));
                preferences.Add(preference);
            }

            if (selectableDay.Is6PMSelected)
            {
                var preference = new Preference(_declaration.Id, selectableDay.Time.AddHours(18));
                preferences.Add(preference);
            }

            if (selectableDay.Is8PMSelected)
            {
                var preference = new Preference(_declaration.Id, selectableDay.Time.AddHours(20));
                preferences.Add(preference);
            }
        }

        await DeclarationManager.DeletePreferencesAsync(_declaration);
        await PreferenceManager.CreateRangeAsync(preferences);

        NavigationManager.NavigateTo($"/m/{_declaration.MeetingId}");
    }
}
